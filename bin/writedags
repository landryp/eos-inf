#!/bin/bash

# Set run parameters

indir=$1 #"/home/philippe.landry/eos-inf"
jobi=$2 #0
numjobs=$3 #1000
perdir=$4 #100
mpereos=$5 #1
gwfile=$6 #"${indir}/in/gwPhenomPNRT_post-lospin.csv"
gpfile=$7 #"${indir}/in/gpr_phi.hdf5"
outdir=$8 #"/home/philippe.landry/eos-inf_test"
mrng=$9 #'1.06,1.46,1.24,1.72'
Mcrng=${10} #'1.184,1.188'
Mobs=${11} #'1.93'
crustdir=${12} # "/home/philippe.landry/gpr-eos-gw170817/eos/eos"

# Create output files and directories

mkdir -p ${outdir}/remote
dagfile1="${outdir}/remote/EOSPRIOR.dag"
dagfile2="${outdir}/remote/INFEREOS.dag"
dagfile3="${outdir}/remote/POSTPLOTS.dag"

infile=${outdir}/remote/writedags.in
echo $indir > $infile
echo $jobi >> $infile
echo $numjobs >> $infile
echo $perdir >> $infile
echo $mpereos >> $infile
echo $gwfile >> $infile
echo $gpfile >> $infile
echo $outdir >> $infile
echo $mrng >> $infile
echo $Mcrng >> $infile
echo $Mobs >> $infile
echo $crustdir >> $infile

sampfile="${outdir}/SAMP.csv"
weightsfile="${outdir}/SAMPweights.csv"
each=1

# Print sub files

binfiles=( "draweos" "getprops" "getbins" "collectbins" "weighsamps" "plotposts" )
args=( "arguments = \"\$(jobi) \$(numjobs) \$(perdir) \$(gpfile) \$(outdir) \$(crustdir)\"" "arguments = \"\$(jobi) \$(numjobs) \$(perdir) \$(outdir)\"" "arguments = \"\$(mpereos) \$(outdir) \$(mrng) \$(Mcrng)\"" "arguments = \"\$(Mobs) \$(outdir)\"" "arguments = \"\$(gwfile) \$(sampfile) \$(weightsfile) \$(outdir)\"" "arguments = \"\$(sampfile) \$(weightsfile) \$(gwfile) \$(outdir) \$(indir)\"" )

for i in $(seq 0 $((${#binfiles[@]}-1)))
do
	binfile=${binfiles[$i]}
	subfile="${outdir}/remote/${binfile}.sub"
	arg=${args[$i]}

	echo "universe = vanilla" > $subfile
	echo "executable = $indir/bin/$binfile" >> $subfile
	echo $arg >> $subfile
	if [ $i -ge 2 ]
	then
		echo "output = $outdir/log/$binfile.out" >> $subfile
		echo "error = $outdir/log/$binfile.err" >> $subfile
		echo "log = $outdir/log/$binfile.log" >> $subfile
	else
		echo "output = $outdir/log/JOB\$(jobi)/$binfile-\$(jobi).out" >> $subfile
		echo "error = $outdir/log/JOB\$(jobi)/$binfile-\$(jobi).err" >> $subfile
		echo "log = $outdir/log/JOB\$(jobi)/$binfile-\$(jobi).log" >> $subfile
	fi
	echo "getenv = True" >> $subfile
	echo "accounting_group = ligo.dev.o2.cbc.pe.lalinference" >> $subfile
	echo "accounting_group_user = philippe.landry" >> $subfile
	echo "queue 1" >> $subfile
done

# Print DAG file 1

echo "### EOS prior process with $numjobs draws from prior $gpfile, reading from $indir and printing to $outdir ###" > $dagfile1

for job in $(seq $jobi $(($jobi+$numjobs-1)))
do
	mkdir -p ${outdir}/log/JOB${job}
	
	echo "JOB $(($job)) $outdir/remote/draweos.sub" >> $dagfile1
	echo "VARS $(($job)) jobi=\"$job\" numjobs=\"$each\" perdir=\"$perdir\" gpfile=\"$gpfile\" outdir=\"$outdir\" crustdir=\"$crustdir\"" >> $dagfile1
	echo "RETRY $(($job)) 1" >> $dagfile1
	echo "PARENT $(($job)) CHILD $(($numjobs+$job))" >> $dagfile1
	
	echo "JOB $(($numjobs+$job)) $outdir/remote/getprops.sub" >> $dagfile1
	echo "VARS $(($numjobs+$job)) jobi=\"$job\" numjobs=\"1\" perdir=\"$perdir\" outdir=\"$outdir\"" >> $dagfile1
	echo "RETRY $(($numjobs+$job)) 1" >> $dagfile1
done

# Print DAG file 2

echo "### EOS inference on $gwfile with $mpereos mass samples per EOS from prior $gpfile, reading from $indir and printing to $outdir ###" > $dagfile2

echo "JOB $(($numjobs+$numjobs)) $outdir/remote/getbins.sub" >> $dagfile2
echo "VARS $(($numjobs+$numjobs)) mpereos=\"$mpereos\" outdir=\"$outdir\" mrng=\"$mrng\" Mcrng=\"$Mcrng\"" >> $dagfile2
echo "RETRY $(($numjobs+$numjobs)) 1" >> $dagfile2
echo "PARENT $(($numjobs+$numjobs)) CHILD $(($numjobs+$numjobs+1))" >> $dagfile2

echo "JOB $(($numjobs+$numjobs+1)) $outdir/remote/collectbins.sub" >> $dagfile2
echo "VARS $(($numjobs+$numjobs+1)) Mobs=\"$Mobs\" outdir=\"$outdir\"" >> $dagfile2
echo "RETRY $(($numjobs+$numjobs+1)) 1" >> $dagfile2
echo "PARENT $(($numjobs+$numjobs+1)) CHILD $(($numjobs+$numjobs+2))" >> $dagfile2

echo "JOB $(($numjobs+$numjobs+2)) $outdir/remote/weighsamps.sub" >> $dagfile2
echo "VARS $(($numjobs+$numjobs+2)) gwfile=\"$gwfile\" sampfile=\"$sampfile\" weightsfile=\"$weightsfile\"" >> $dagfile2
echo "RETRY $(($numjobs+$numjobs+2)) 1" >> $dagfile2

# Print DAG file 3

echo "### Plots of EOS posterior from $gpfile reweighted by $gwfile, reading from $indir and printing to $outdir ###" > $dagfile3

echo "JOB $(($numjobs+$numjobs+3)) $outdir/remote/plotposts.sub" >> $dagfile3
echo "VARS $(($numjobs+$numjobs+3)) sampfile=\"$sampfile\" weightsfile=\"$weightsfile\" gwfile=\"$gwfile\" outdir=\"$outdir\" indir=\"$indir\"" >> $dagfile3
echo "RETRY $(($numjobs+$numjobs+3)) 1" >> $dagfile3

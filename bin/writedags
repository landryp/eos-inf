#!/bin/bash

# Set run parameters

indir="/home/philippe.landry/eos-inf"
gpfile="${indir}/in/gpr_phi.hdf5"
outdir="/home/philippe.landry/eos-inf_test"

numjobs=1000
mpereos=1
gwfile="${indir}/in/gwPhenomPNRT_post-lospin.csv"
mrng='1.06,1.46,1.24,1.72'
Mcrng='1.184,1.188'
Mobs='1.93'

mkdir -p ${outdir}/remote

jobi=0
perdir=100
dagfile1="${outdir}/remote/EOSPRIOR.dag"
dagfile2="${outdir}/remote/INFEREOS.dag"
dagfile3="${outdir}/remote/POSTPLOTS.dag"

sampfile="${outdir}/SAMP.csv"
weightsfile="${outdir}/SAMPweights.csv"
each=1

# Print DAG file 1
echo "### EOS prior process with $numjobs draws from prior $gpfile, reading from $indir and printing to $outdir ###" > $dagfile

for job in $(seq $jobi $(($jobi+$numjobs-1)))
do
	mkdir -p ${outdir}/log/JOB${job}
	
	echo "JOB $(($job)) $outdir/remote/draweos.sub" >> $dagfile
	echo "VARS $(($job)) jobi=\"$job\" numjobs=\"$each\" perdir=\"$perdir\" gpfile=\"$gpfile\" outdir=\"$outdir\"" >> $dagfile
	echo "RETRY $(($job)) 1" >> $dagfile
	echo "PARENT $(($job)) CHILD $(($numjobs+$job))" >> $dagfile
	
	echo "JOB $(($numjobs+$job)) $outdir/remote/getprops.sub" >> $dagfile
	echo "VARS $(($numjobs+$job)) jobi=\"$job\" numjobs=\"1\" perdir=\"$perdir\" outdir=\"$outdir\"" >> $dagfile
	echo "RETRY $(($numjobs+$job)) 1" >> $dagfile
done

# Print DAG file 2
echo "### EOS inference on $gwfile with $mpereos mass samples per EOS from prior $gpfile, reading from $indir and printing to $outdir ###" > $dagfile2

echo "JOB $(($numjobs+$numjobs)) $outdir/remote/getbins.sub" >> $dagfile2
echo "VARS $(($numjobs+$numjobs)) mpereos=\"$mpereos\" outdir=\"$outdir\" mrng=\"$mrng\" Mcrng=\"$Mcrng\"" >> $dagfile2
echo "RETRY $(($numjobs+$numjobs)) 1" >> $dagfile2
echo "PARENT $(($numjobs+$numjobs)) CHILD $(($numjobs+$numjobs+1))" >> $dagfile2

echo "JOB $(($numjobs+$numjobs+1)) $outdir/remote/collectbins.sub" >> $dagfile2
echo "VARS $(($numjobs+$numjobs+1)) Mobs=\"$Mobs\" outdir=\"$outdir\"" >> $dagfile2
echo "RETRY $(($numjobs+$numjobs+1)) 1" >> $dagfile2
echo "PARENT $(($numjobs+$numjobs+1)) CHILD $(($numjobs+$numjobs+2))" >> $dagfile2

echo "JOB $(($numjobs+$numjobs+2)) $outdir/remote/weighsamps.sub" >> $dagfile2
echo "VARS $(($numjobs+$numjobs+2)) gwfile=\"$gwfile\" sampfile=\"$sampfile\" weightsfile=\"$weightsfile\"" >> $dagfile2
echo "RETRY $(($numjobs+$numjobs+2)) 1" >> $dagfile2

# Print DAG file 3
echo "### Plots of EOS posterior from $gpfile reweighted by $gwfile, reading from $indir and printing to $outdir ###" > $dagfile3

echo "JOB $(($numjobs+$numjobs+3)) $outdir/remote/plotposts.sub" >> $dagfile3
echo "VARS $(($numjobs+$numjobs+3)) sampfile=\"$sampfile\" weightsfile=\"$weightsfile\" gwfile=\"$gwfile\" outdir=\"$outdir\"" >> $dagfile3
echo "RETRY $(($numjobs+$numjobs+3)) 1" >> $dagfile3

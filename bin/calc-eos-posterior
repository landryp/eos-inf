#!/bin/bash

obslist=$1
eosbank=$2
numeos=$3
nummass=$4

while IFS=, read -r likepath obstype
do
	likemetapath="${likepath%.*}.in"
	parse-likelihood-samples $obstype $likepath $likemetapath

	while IFS=, read -r prop lb ub bw
	do
		priorpath="${likepath%.*}_prior.json"
		if [ "$obstype" == "cbc" ]; then
			if [ "$prop" == "m1" ]; then
			gub=$ub
			elif [ "$prop" == "m2" ]; then
			llb=$lb
			sample-priors $eosbank $priorpath -O $obstype -n $numeos -N $nummass -m "$llb,$gub" -p flat
			break
			fi
		else
			if [ "$prop" == "m" ]; then
			sample-priors $eosbank $priorpath -O $obstype -n $numeos -N $nummass -m "$lb,$ub" -p flat
			break
			fi
		fi
	done < $likemetapath

	priorcsvpath="${priorpath%.*}.csv"
	convert-json-csv $priorpath $priorcsvpath

	postpath="${likepath%.*}_post.csv"
	weigh-samples $likepath $priorcsvpath $postpath m R -v --bandwidth=$bw #--weight-column Prior --weight-column-is-log Prior --invert-weight-column Prior 

	eospath="${likepath%.*}_eos.csv"
	marginalize-samples $postpath eos -o $eospath --weight-column logweight --weight-column-is-log logweight -v

done < $obslist

# convert to json with convert-json-csv
